<head>
    <title>Gestion des Stages - Plannification</title>
    <%-include('./common/head') %>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

 
</head>
<body>
    <div class="custom-container">
        <%-include('./common/sidebar') %>
        <div class="main-content"  style="margin-left: 5px;">

        
            <ul class="nav-item">
                <div class="language-selector">
                    <select id="language-select" class="form-control">
                        <option value="en">English</option>
                        <option value="fr">Français</option>
                        <option value="ar">arabe</option>
                    </select>
                </div>
            </ul>



            <%-include('./partial/toast') %>




            <h1>Soutenances</h1>
            <div class="d-flex justify-content-start mt-3">
                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#addSoutenanceModal">
                    <i class="bi bi-person-plus"></i> Ajouter une Soutenance
                </button>
                <button type="button" class="btn btn-outline-secondary ms-auto" id="updateTableButton">
                    <i class="bi bi-arrow-repeat"></i> Mettre à jour le table
                </button>
            </div>
            

           
            <hr style="padding: 5px;">
          <div class="myElement">  
            <table id="soutenances-table" class="  searchable sortable">
                <thead>
                    <tr>
                        <th>Action</th>  <!-- Add a new column for action buttons -->
                        
                        <th>ID</th>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Salle</th>
                        <th>Groupe</th>
                        <th>Type</th>
                        <th>Etudiant 1</th>
                        <th>Etudiant 2</th>
                        <th>Etudiant 3</th>
                        <th>Sujet</th>
                        <th>President</th>
                        <th>Rapporteur</th>
                        <th>Encadrant Academique</th>
                        <th>Encadrant Professionnel</th>
                        <th>Entreprise</th>
                    </tr>
                </thead>
                <tbody>
                    <% soutenances.forEach(function(soutenance) { %>
                        <tr data-id="<%= soutenance.id %>">
                            <td>
                                <button class="btn btn-sm btn-outline-warning delete-btn" data-id="<%= soutenance.id %>">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                            <td><%= soutenance.id %></td>
                            <td><input type="date" value="<%= soutenance.date %>" data-field="date"></td>
                            <td><input type="time" value="<%= soutenance.time %>" data-field="time"></td>
                            <td><input type="text" value="<%= soutenance.salle %>" data-field="salle"></td>
                            <td><input type="text" value="<%= soutenance.groupe %>" data-field="groupe"></td>
                            <td>
                                <select data-field="type">
                                    <option value="Binome" <%= soutenance.type === 'Binome' ? 'selected' : '' %>>Binome</option>
                                    <option value="Monome" <%= soutenance.type === 'Monome' ? 'selected' : '' %>>Monome</option>
                                    <option value="Trinome" <%= soutenance.type === 'Trinome' ? 'selected' : '' %>>Trinome</option>
                                </select>
                            </td>
                            <td><input type="text" value="<%= soutenance.etudiant1 %>" data-field="etudiant1"></td>
                            <td><input type="text" value="<%= soutenance.etudiant2 %>" data-field="etudiant2"></td>
                            <td><input type="text" value="<%= soutenance.etudiant3 %>" data-field="etudiant3"></td>
                            <td><input type="text" value="<%= soutenance.sujet %>" data-field="sujet"></td>
                            <td><input type="text" value="<%= soutenance.president %>" data-field="president"></td>
                            <td><input type="text" value="<%= soutenance.rapporteur %>" data-field="rapporteur"></td>
                            <td><input type="text" value="<%= soutenance.encadrantAcademique %>" data-field="encadrantAcademique"></td>
                            <td><input type="text" value="<%= soutenance.encadrantProfessionnel %>" data-field="encadrantProfessionnel"></td>
                            <td><input type="text" value="<%= soutenance.entreprise %>" data-field="entreprise"></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>     
            <hr>
            <%-include('./common/footer') %>
        </div>
    </div>


    <script>
$(document).ready(function() {
  $('#soutenances-table input, #soutenances-table select').on('blur', function() {
    var $row = $(this).closest('tr');
    var id = $row.data('id');
    var formData = {};
    $row.find('input, select').each(function() {
      var field = $(this).data('field');
      var value = $(this).val();
      if (value.trim() !== '') {
        formData[field] = value;
      }
    });
    $.ajax({
      url: '/planification/soutenances/' + id,
      method: 'POST',
      data: formData,
      success: function(response) {
  if (response.conflictingData && response.conflictingData.length > 0) {
    var conflictingData = response.conflictingData;
    var conflictMessage = 'Conflit détecté avec les soutenances suivantes : ';

    conflictingData.forEach(function(conflict) {
      // Clean up the conflict object by removing undefined or empty string values
      var cleanedConflict = {};
      for (var key in conflict) {
        if (conflict[key] !== undefined && conflict[key] !== '') {
          cleanedConflict[key] = conflict[key];
        }
      }

      conflictMessage += '\n- La table ID: ' + (cleanedConflict.id || 'Non spécifié');
      if (cleanedConflict.date) conflictMessage += ', Date: ' + cleanedConflict.date;
      if (cleanedConflict.time) conflictMessage += ', Heure: ' + cleanedConflict.time;
      if (cleanedConflict.salle) conflictMessage += ', Salle: ' + cleanedConflict.salle;
      if (cleanedConflict.president) conflictMessage += ', Président: ' + cleanedConflict.president;
      if (cleanedConflict.rapporteur) conflictMessage += ', Rapporteur: ' + cleanedConflict.rapporteur;
      if (cleanedConflict.encadrantAcademique) conflictMessage += ', Encadrant Académique: ' + cleanedConflict.encadrantAcademique;
      if (cleanedConflict.encadrantProfessionnel) conflictMessage += ', Encadrant Professionnel: ' + cleanedConflict.encadrantProfessionnel;
    });
          $row.addClass('conflict');
          // Dispose the old tooltip if any
          $row.tooltip('dispose');
          // Dynamically set tooltip content
          $row.tooltip({
            title: conflictMessage,
            placement: 'top',
            container: 'body',
            trigger: 'hover' // Change this to 'hover' to keep the tooltip visible
          });
          $row.tooltip('show'); // Show the tooltip immediately
        } else {
          // No conflicts, show success message
          $('#successToast .toast-body').text(`Soutenance id : ${id} mise à jour avec succès.`);
          var successToastEl = document.getElementById('successToast');
          var successToast = new bootstrap.Toast(successToastEl);
          successToast.show();
          // Remove conflict class and tooltip
          $row.removeClass('conflict');
          $row.tooltip('dispose');
          $row.addClass('update-success');
          setTimeout(function() {
            $row.removeClass('update-success');
          }, 500);
        }
      },
      error: function(err) {
        console.error('Error updating:', err);
        $('#errorToast .toast-body').text('Erreur lors de la mise à jour de la soutenance. Veuillez réessayer.');
        var errorToastEl = document.getElementById('errorToast');
        var errorToast = new bootstrap.Toast(errorToastEl);
        errorToast.show();
      }
    });
  });

  // Remove the mousemove and mouseleave events, as they are no longer needed
  // when the tooltip is set to 'hover' mode
});
        </script>
        
        
<script>
    $(document).ready(function() {
        // Your existing code for updating soutenances
    
        // Handle form submission
        $('#submitSoutenance').on('click', function() {
            var formData = $('#addSoutenanceForm').serialize();

            console.log(formData)
        
            
            $.ajax({
    url: '/planification/Addsoutenances',
    method: 'POST',
    data: formData,
    success: function(response) {
        console.log('Soutenance added successfully:', response);
        $('#addSoutenanceModal').modal('hide');

        // Set success message and show the toast
        $('#successToast .toast-body').text('Soutenance ajoutée avec succès.');
        var successToastEl = document.getElementById('successToast');
        var successToast = new bootstrap.Toast(successToastEl);
        successToast.show();

       location.reload(); // Optionally, refresh the table or add the new row
    },
    error: function(err) {
        console.error('Error adding soutenance:', err);
        
        // Set error message and show the toast
        $('#errorToast .toast-body').text('Erreur lors de l\'ajout de la soutenance. Veuillez réessayer.');
        var errorToastEl = document.getElementById('errorToast');
        var errorToast = new bootstrap.Toast(errorToastEl);
        errorToast.show();
    }
});

        });
    });
    </script>



   <script>
    $(document).ready(function() {
  // ...

  // Delete button click event
  $('#soutenances-table').on('click', '.delete-btn', function() {
    var id = $(this).data('id');
    $('#delete-soutenance-id').text(id); // Set the soutenance ID in the modal
    $('#deleteModal').data('id', id); // Store the ID in the modal
    $('#deleteModal').modal('show'); // Show the delete confirmation modal
  });

  // Delete confirmation button click event
  $('#deleteModal').on('click', '.delete-confirm-btn', function() {
    var id = $('#deleteModal').data('id');
    $.ajax({
      url: '/planification/soutenances/' + id,
      method: 'DELETE',
      success: function(response) {
        // Show success toast
        $('#successToast .toast-body').text(`Soutenance ID ${id} supprimée avec succès.`);
        var successToastEl = document.getElementById('successToast');
        var successToast = new bootstrap.Toast(successToastEl);
        successToast.show();

        // Remove the deleted row from the table
        $(`tr[data-id="${id}"]`).remove();
        $('#deleteModal').modal('hide'); // Hide the modal
      },
      error: function(err) {
        // Show error toast
        $('#errorToast .toast-body').text(`Erreur lors de la suppression de la soutenance ID ${id}. Veuillez réessayer.`);
        var errorToastEl = document.getElementById('errorToast');
        var errorToast = new bootstrap.Toast(errorToastEl);
        errorToast.show();
        $('#deleteModal').modal('hide'); // Hide the modal
      }
    });
  });

  // ...
});
   </script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</html>